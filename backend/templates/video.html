{% extends "base.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –í–∏–¥–µ–æ - EKOSYSTEMA{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –í–∏–¥–µ–æ</h1>
        <p class="mt-2 text-gray-600">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">üé•</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">–í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ</dt>
                            <dd class="text-lg font-medium text-gray-900" id="videos-created">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">‚è±Ô∏è</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</dt>
                            <dd class="text-lg font-medium text-gray-900" id="avg-time">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">üìä</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</dt>
                            <dd class="text-lg font-medium text-gray-900" id="processing">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <span class="text-white text-sm font-bold">üíæ</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤</dt>
                            <dd class="text-lg font-medium text-gray-900" id="total-size">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-6 text-gray-900">üöÄ –°–æ–∑–¥–∞—Ç—å –í–∏–¥–µ–æ</h2>
            
            <form id="video-form">
                <!-- –¢–µ–∫—Å—Ç –¥–ª—è –≤–∏–¥–µ–æ -->
                <div class="mb-4">
                    <label for="video-text" class="block text-sm font-medium text-gray-700 mb-2">
                        –¢–µ–∫—Å—Ç –¥–ª—è –≤–∏–¥–µ–æ *
                    </label>
                    <textarea 
                        id="video-text" 
                        name="text" 
                        rows="4" 
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω –≤ –≤–∏–¥–µ–æ..."
                        required
                    ></textarea>
                    <p class="mt-1 text-sm text-gray-500">–¢–µ–∫—Å—Ç –±—É–¥–µ—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑–∞–Ω —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π</p>
                </div>

                <!-- –¢–∏–ø –≤–∏–¥–µ–æ -->
                <div class="mb-4">
                    <label for="video-type" class="block text-sm font-medium text-gray-700 mb-2">
                        –¢–∏–ø –≤–∏–¥–µ–æ
                    </label>
                    <select id="video-type" name="video_type" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                        <option value="animated_text">–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</option>
                        <option value="image_slideshow">–°–ª–∞–π–¥—à–æ—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</option>
                        <option value="template_based">–ù–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞</option>
                    </select>
                </div>

                <!-- –°—Ç–∏–ª—å -->
                <div class="mb-4">
                    <label for="style" class="block text-sm font-medium text-gray-700 mb-2">
                        –°—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
                    </label>
                    <select id="style" name="style" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                        <option value="modern">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>
                        <option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
                        <option value="minimal">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</option>
                        <option value="colorful">–Ø—Ä–∫–∏–π</option>
                        <option value="dark">–¢—ë–º–Ω—ã–π</option>
                    </select>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                            –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)
                        </label>
                        <input 
                            type="number" 
                            id="duration" 
                            name="duration" 
                            min="5" 
                            max="120" 
                            value="30"
                            class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        >
                    </div>
                    <div>
                        <label for="resolution" class="block text-sm font-medium text-gray-700 mb-2">
                            –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                        </label>
                        <select id="resolution" name="resolution" class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                            <option value="1080x1920">1080x1920 (TikTok/Instagram)</option>
                            <option value="1920x1080">1920x1080 (YouTube)</option>
                            <option value="1080x1080">1080x1080 (Instagram –∫–≤–∞–¥—Ä–∞—Ç)</option>
                            <option value="720x1280">720x1280 (HD –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ)</option>
                        </select>
                    </div>
                </div>

                <!-- –ê—É–¥–∏–æ—Ñ–∞–π–ª -->
                <div class="mb-6">
                    <label for="audio-path" class="block text-sm font-medium text-gray-700 mb-2">
                        –ê—É–¥–∏–æ—Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    </label>
                    <input 
                        type="text" 
                        id="audio-path" 
                        name="audio_path" 
                        placeholder="–ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º"
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                    >
                    <p class="mt-1 text-sm text-gray-500">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –≤–∏–¥–µ–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –±–µ–∑ –∑–≤—É–∫–∞</p>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                <button 
                    type="submit" 
                    id="generate-btn"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-md transition duration-200"
                >
                    üé¨ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –í–∏–¥–µ–æ
                </button>
            </form>

            <!-- –°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
            <div id="generation-status" class="mt-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">
                                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...
                            </h3>
                            <div class="mt-1 text-sm text-blue-700">
                                <span id="status-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
                            </div>
                            <div class="mt-2">
                                <div class="bg-blue-200 rounded-full h-2">
                                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∏–¥–µ–æ -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-6 text-gray-900">üìπ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –í–∏–¥–µ–æ</h2>
            
            <div id="recent-videos" class="space-y-4">
                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
            <button 
                onclick="loadRecentVideos()" 
                class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md transition duration-200"
            >
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            </button>
        </div>
    </div>

    <!-- –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="mt-8 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-900">‚ÑπÔ∏è –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <div id="system-info" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
            <div>
                <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã:</strong>
                <span id="available-types">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div>
                <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∏–ª–∏:</strong>
                <span id="available-styles">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div>
                <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:</strong>
                <span id="supported-resolutions">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>
</div>

<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let currentTaskId = null;
let statusInterval = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();
    loadRecentVideos();
    loadStatistics();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('video-form').addEventListener('submit', generateVideo);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
async function loadSystemInfo() {
    try {
        const response = await fetch('/api/video/info');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('available-types').textContent = data.available_types.join(', ');
            document.getElementById('available-styles').textContent = data.available_styles.join(', ');
            document.getElementById('supported-resolutions').textContent = 
                data.supported_resolutions.map(r => r.join('x')).join(', ');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:', error);
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
async function generateVideo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const videoData = {
        text: formData.get('text'),
        video_type: formData.get('video_type'),
        style: formData.get('style'),
        duration: parseInt(formData.get('duration')),
        resolution: formData.get('resolution'),
        audio_path: formData.get('audio_path') || null
    };
    
    if (!videoData.text.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∏–¥–µ–æ');
        return;
    }
    
    try {
        // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('generate-btn').disabled = true;
        document.getElementById('generate-btn').textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById('generation-status').classList.remove('hidden');
        
        const response = await fetch('/api/video/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(videoData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTaskId = result.task_id;
            document.getElementById('status-text').textContent = '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é...';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            startStatusTracking();
        } else {
            throw new Error(result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        resetForm();
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
function startStatusTracking() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
    
    statusInterval = setInterval(async () => {
        if (!currentTaskId) return;
        
        try {
            const response = await fetch(`/api/tasks/${currentTaskId}`);
            const result = await response.json();
            
            document.getElementById('progress-bar').style.width = result.progress + '%';
            
            if (result.status === 'completed') {
                document.getElementById('status-text').textContent = '‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!';
                clearInterval(statusInterval);
                resetForm();
                loadRecentVideos();
                loadStatistics();
                
                setTimeout(() => {
                    document.getElementById('generation-status').classList.add('hidden');
                }, 3000);
                
            } else if (result.status === 'failed') {
                document.getElementById('status-text').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (result.error_message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                clearInterval(statusInterval);
                resetForm();
                
                setTimeout(() => {
                    document.getElementById('generation-status').classList.add('hidden');
                }, 5000);
                
            } else if (result.status === 'running') {
                document.getElementById('status-text').textContent = 'üé¨ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–¥–µ–æ...';
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }, 2000);
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
function resetForm() {
    document.getElementById('generate-btn').disabled = false;
    document.getElementById('generate-btn').textContent = 'üé¨ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –í–∏–¥–µ–æ';
    currentTaskId = null;
    
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–∏–¥–µ–æ
async function loadRecentVideos() {
    try {
        const response = await fetch('/api/tasks?type=video_generation&limit=10');
        const tasks = await response.json();
        
        const container = document.getElementById('recent-videos');
        
        if (!Array.isArray(tasks) || tasks.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</p>';
            return;
        }
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
        const videoTasks = tasks.filter(task => task.type === 'video_generation');
        
        if (videoTasks.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</p>';
            return;
        }
        
        container.innerHTML = videoTasks.map(task => {
            const statusIcon = {
                'completed': '‚úÖ',
                'running': '‚è≥',
                'failed': '‚ùå',
                'pending': '‚è∏Ô∏è'
            }[task.status] || '‚ùì';
            
            const date = new Date(task.created_at).toLocaleString('ru-RU');
            const result = task.result || {};
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${statusIcon}</span>
                                <span class="font-medium text-gray-900">–í–∏–¥–µ–æ ${task.id.slice(0, 8)}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${date}</p>
                            ${result.duration ? `<p class="text-sm text-gray-500">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${result.duration.toFixed(1)}—Å</p>` : ''}
                            ${result.file_size ? `<p class="text-sm text-gray-500">–†–∞–∑–º–µ—Ä: ${(result.file_size / 1024 / 1024).toFixed(1)} –ú–ë</p>` : ''}
                            ${result.resolution ? `<p class="text-sm text-gray-500">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${result.resolution.join('x')}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                ${task.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                  task.status === 'running' ? 'bg-blue-100 text-blue-800' :
                                  task.status === 'failed' ? 'bg-red-100 text-red-800' : 
                                  'bg-gray-100 text-gray-800'}">
                                ${task.status === 'completed' ? '–ì–æ—Ç–æ–≤–æ' :
                                  task.status === 'running' ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' :
                                  task.status === 'failed' ? '–û—à–∏–±–∫–∞' : '–û–∂–∏–¥–∞–Ω–∏–µ'}
                            </span>
                        </div>
                    </div>
                    ${task.status === 'failed' && task.error_message ? 
                        `<p class="text-sm text-red-600 mt-2">–û—à–∏–±–∫–∞: ${task.error_message}</p>` : ''}
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ:', error);
        document.getElementById('recent-videos').innerHTML = 
            '<p class="text-red-500 text-center py-4">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</p>';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function loadStatistics() {
    try {
        const response = await fetch('/api/tasks?type=video_generation');
        const tasks = await response.json();
        
        if (Array.isArray(tasks)) {
            const videoTasks = tasks.filter(task => task.type === 'video_generation');
            const completedTasks = videoTasks.filter(task => task.status === 'completed');
            const runningTasks = videoTasks.filter(task => task.status === 'running');
            
            // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
            document.getElementById('videos-created').textContent = completedTasks.length;
            
            // –ó–∞–¥–∞—á–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
            document.getElementById('processing').textContent = runningTasks.length;
            
            // –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            const tasksWithTime = completedTasks.filter(task => task.result?.generation_time);
            if (tasksWithTime.length > 0) {
                const avgTime = tasksWithTime.reduce((sum, task) => sum + task.result.generation_time, 0) / tasksWithTime.length;
                document.getElementById('avg-time').textContent = avgTime.toFixed(1) + '—Å';
            } else {
                document.getElementById('avg-time').textContent = 'N/A';
            }
            
            // –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
            const tasksWithSize = completedTasks.filter(task => task.result?.file_size);
            if (tasksWithSize.length > 0) {
                const totalSize = tasksWithSize.reduce((sum, task) => sum + task.result.file_size, 0);
                document.getElementById('total-size').textContent = (totalSize / 1024 / 1024).toFixed(1) + ' –ú–ë';
            } else {
                document.getElementById('total-size').textContent = '0 –ú–ë';
            }
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    if (!currentTaskId) {
        loadRecentVideos();
        loadStatistics();
    }
}, 30000);
</script>
{% endblock %}